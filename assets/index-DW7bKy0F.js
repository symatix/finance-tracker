import{l as k,m as M,r as y,j as e,K as W,B as R,T as I,L as q,w as T,H as D,F as C,I as w,S as _,M as p,J as S,N as L,v as N}from"./index-7Ccxyq_g.js";import{C as A,A as F}from"./Close-CUb_fB2v.js";import{f as B}from"./formatCurrency-DRYgsAPj.js";import{T as U,a as Y,b as z,c as O,d as o,e as H}from"./TableRow-LrOC3fnA.js";import{E as J,D as K,a as Q,b as V,c as $,d as G}from"./Edit-CS56Aevz.js";import{P as X}from"./Pagination-iZ3o2GGA.js";import{D as Z}from"./Divider-8rNOQW4G.js";function ee(){const{user:s}=k(),{recurringTransactions:c,addRecurringTransaction:u,updateRecurringTransaction:a,deleteRecurringTransaction:h,loadRecurringTransactions:t,processDueRecurringTransactions:i}=M(),[x,r]=y.useState(!1);return y.useEffect(()=>{s&&c.length===0&&t(s.id)},[s,t,c.length]),{recurringTransactions:c,loading:x,createRecurring:async d=>{if(s){r(!0);try{await u(s.id,{...d,user_id:s.id})}finally{r(!1)}}},updateRecurring:async(d,v)=>{if(s){r(!0);try{await a(s.id,d,v)}finally{r(!1)}}},deleteRecurring:async d=>{if(s){r(!0);try{await h(s.id,d)}finally{r(!1)}}},processDueRecurring:async()=>{if(s){r(!0);try{await i(s.id)}finally{r(!1)}}}}}function P({open:s,onClose:c,onSubmit:u,editingRecurring:a}){const{categories:h}=M(),[t,i]=y.useState({name:"",amount:"",type:"Expense",category_id:"",subcategory:"",note:"",frequency:"monthly",start_date:new Date().toISOString().split("T")[0],end_date:""}),[x,r]=y.useState(!1);y.useEffect(()=>{i(a?{name:a.name,amount:a.amount.toString(),type:a.type,category_id:a.category_id,subcategory:a.subcategory||"",note:a.note||"",frequency:a.frequency,start_date:a.start_date,end_date:a.end_date||""}:{name:"",amount:"",type:"Expense",category_id:"",subcategory:"",note:"",frequency:"monthly",start_date:new Date().toISOString().split("T")[0],end_date:""})},[a,s]);const g=async n=>{n.preventDefault(),r(!0);try{await u({name:t.name,amount:parseFloat(t.amount),type:t.type,category_id:t.category_id,subcategory:t.subcategory||null,note:t.note,frequency:t.frequency,start_date:t.start_date,end_date:t.end_date||null,next_due_date:t.start_date,is_active:!0})}catch(d){console.error("Error submitting recurring transaction:",d)}finally{r(!1)}},f=h.find(n=>n.id===t.category_id)?.subcategories||[];return e.jsx(W,{anchor:"right",open:s,onClose:c,PaperProps:{sx:{width:{xs:"100%",sm:400}}},children:e.jsxs(R,{sx:{p:3,height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(R,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(I,{variant:"h6",children:a?"Edit Recurring Transaction":"New Recurring Transaction"}),e.jsx(q,{onClick:c,size:"small",children:e.jsx(A,{})})]}),e.jsxs(R,{component:"form",onSubmit:g,sx:{flex:1,display:"flex",flexDirection:"column"},children:[e.jsxs(T,{spacing:3,sx:{flex:1},children:[e.jsx(D,{label:"Name",value:t.name,onChange:n=>i({...t,name:n.target.value}),required:!0,fullWidth:!0,placeholder:"e.g., Netflix Subscription"}),e.jsxs(T,{direction:{xs:"column",sm:"row"},spacing:2,children:[e.jsx(D,{label:"Amount",type:"number",value:t.amount,onChange:n=>i({...t,amount:n.target.value}),required:!0,fullWidth:!0,inputProps:{min:"0",step:"0.01"}}),e.jsxs(C,{fullWidth:!0,required:!0,children:[e.jsx(w,{children:"Type"}),e.jsxs(_,{value:t.type,label:"Type",onChange:n=>i({...t,type:n.target.value}),children:[e.jsx(p,{value:"Income",children:"Income"}),e.jsx(p,{value:"Expense",children:"Expense"}),e.jsx(p,{value:"Savings",children:"Savings"})]})]})]}),e.jsxs(C,{fullWidth:!0,required:!0,children:[e.jsx(w,{children:"Category"}),e.jsx(_,{value:t.category_id,label:"Category",onChange:n=>i({...t,category_id:n.target.value,subcategory:""}),children:h.filter(n=>n.type===t.type).map(n=>e.jsx(p,{value:n.id,children:n.name},n.id))})]}),f.length>0&&e.jsxs(C,{fullWidth:!0,children:[e.jsx(w,{children:"Subcategory"}),e.jsxs(_,{value:t.subcategory,label:"Subcategory",onChange:n=>i({...t,subcategory:n.target.value}),children:[e.jsx(p,{value:"",children:e.jsx("em",{children:"None"})}),f.map(n=>e.jsx(p,{value:n,children:n},n))]})]}),e.jsxs(C,{fullWidth:!0,required:!0,children:[e.jsx(w,{children:"Frequency"}),e.jsxs(_,{value:t.frequency,label:"Frequency",onChange:n=>i({...t,frequency:n.target.value}),children:[e.jsx(p,{value:"daily",children:"Daily"}),e.jsx(p,{value:"weekly",children:"Weekly"}),e.jsx(p,{value:"monthly",children:"Monthly"}),e.jsx(p,{value:"yearly",children:"Yearly"})]})]}),e.jsxs(T,{direction:{xs:"column",sm:"row"},spacing:2,children:[e.jsx(D,{label:"Start Date",type:"date",value:t.start_date,onChange:n=>i({...t,start_date:n.target.value}),required:!0,fullWidth:!0,InputLabelProps:{shrink:!0}}),e.jsx(D,{label:"End Date (Optional)",type:"date",value:t.end_date,onChange:n=>i({...t,end_date:n.target.value}),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:"Leave empty for indefinite"})]}),e.jsx(D,{label:"Note",value:t.note,onChange:n=>i({...t,note:n.target.value}),fullWidth:!0,multiline:!0,rows:2,placeholder:"Optional notes about this recurring transaction"})]}),e.jsxs(T,{direction:"row",spacing:2,sx:{mt:4},children:[e.jsx(S,{onClick:c,fullWidth:!0,disabled:x,children:"Cancel"}),e.jsx(S,{type:"submit",variant:"contained",fullWidth:!0,disabled:x,children:x?"Saving...":a?"Update":"Create"})]})]})]})})}function te(s,c,u){const[a,h]=y.useState(1),t=10,[i,x]=y.useState(!1),[r,g]=y.useState(null),[b,f]=y.useState(!1),[n,d]=y.useState(null),v=y.useMemo(()=>{const j=(a-1)*t;return s.slice(j,j+t)},[s,a]),m=Math.ceil(s.length/t);return{page:a,setPage:h,totalPages:m,paginatedTransactions:v,modalOpen:i,selectedTransaction:r,closeModal:()=>{x(!1),g(null)},confirmOpen:b,editTransaction:j=>{g(j),x(!0)},deleteTransaction:j=>{d(j),f(!0)},confirmDelete:()=>{n&&u(n),f(!1),d(null)},cancelDelete:()=>{f(!1),d(null)},saveTransaction:async j=>{r&&await c(r.id,j),x(!1),g(null)}}}const ne={daily:"Daily",weekly:"Weekly",monthly:"Monthly",yearly:"Yearly"},ae=(s,c)=>{if(!s)return"default";const u=new Date().toISOString().split("T")[0],a=new Date(c),h=new Date(u);return a<h?"error":a.toISOString().split("T")[0]===u?"warning":"success"},se=(s,c)=>{if(!s)return"Inactive";const u=new Date().toISOString().split("T")[0],a=new Date(c),h=new Date(u);return a<h?"Overdue":a.toISOString().split("T")[0]===u?"Due Today":"Active"};function re({recurringTransactions:s,onUpdateRecurring:c,onDeleteRecurring:u}){const{page:a,setPage:h,totalPages:t,paginatedTransactions:i,modalOpen:x,selectedTransaction:r,confirmOpen:g,editTransaction:b,deleteTransaction:f,confirmDelete:n,cancelDelete:d,saveTransaction:v,closeModal:m}=te(s,c,u);return e.jsxs(e.Fragment,{children:[e.jsx(U,{component:L,children:e.jsxs(Y,{children:[e.jsx(z,{children:e.jsxs(O,{children:[e.jsx(o,{children:"Name"}),e.jsx(o,{children:"Amount"}),e.jsx(o,{children:"Type"}),e.jsx(o,{children:"Category"}),e.jsx(o,{children:"Frequency"}),e.jsx(o,{children:"Next Due"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Note"}),e.jsx(o,{align:"right",children:"Actions"})]})}),e.jsx(H,{children:i.map(l=>e.jsxs(O,{sx:{opacity:l.is_active?1:.7},children:[e.jsx(o,{children:l.name}),e.jsx(o,{sx:{fontWeight:"bold"},children:B(l.amount)}),e.jsx(o,{children:l.type}),e.jsxs(o,{children:[l.categoryName," ",l.subcategory&&` / ${l.subcategory}`]}),e.jsx(o,{children:ne[l.frequency]}),e.jsx(o,{children:new Date(l.next_due_date).toLocaleDateString()}),e.jsx(o,{children:e.jsx(N,{label:se(l.is_active,l.next_due_date),color:ae(l.is_active,l.next_due_date),size:"small"})}),e.jsx(o,{children:l.note||"-"}),e.jsx(o,{align:"right",children:e.jsxs(T,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(q,{color:"primary",onClick:()=>b(l),children:e.jsx(J,{})}),e.jsx(q,{color:"error",onClick:()=>f(l.id),children:e.jsx(K,{})})]})})]},l.id))})]})}),e.jsx(T,{mt:2,alignItems:"center",children:e.jsx(X,{count:t,page:a,onChange:(l,E)=>h(E),color:"primary"})}),x&&r&&e.jsx(P,{open:x,onClose:m,onSubmit:v,editingRecurring:r}),e.jsxs(Q,{open:g,onClose:d,children:[e.jsx(V,{children:"Confirm Delete"}),e.jsx($,{children:e.jsx(I,{children:"Are you sure you want to delete this recurring transaction?"})}),e.jsxs(G,{children:[e.jsx(S,{onClick:d,children:"Cancel"}),e.jsx(S,{color:"error",variant:"contained",onClick:n,children:"Delete"})]})]})]})}function me(){const{user:s}=k(),{recurringTransactions:c,loading:u,createRecurring:a,updateRecurring:h,deleteRecurring:t}=ee(),[i,x]=y.useState(!1),[r,g]=y.useState(void 0),b=()=>{g(void 0),x(!0)},f=()=>{x(!1),g(void 0)},n=async m=>{r?await h(r.id,m):await a(m),f()},d=async(m,l)=>{await h(m,l)},v=async m=>{confirm("Are you sure you want to delete this recurring transaction?")&&await t(m)};return s?e.jsxs(R,{p:4,children:[e.jsxs(T,{direction:{xs:"column",sm:"row"},justifyContent:{xs:"flex-start",sm:"space-between"},alignItems:{xs:"flex-start",sm:"center"},mb:1,spacing:2,children:[e.jsx(I,{variant:"h5",children:"Recurring Transactions"}),e.jsx(S,{variant:"contained",startIcon:e.jsx(F,{}),onClick:b,sx:{width:{xs:"100%",sm:"auto"}},children:"New Recurring"})]}),e.jsx(Z,{sx:{mb:3}}),u?e.jsx(I,{children:"Loading..."}):e.jsx(re,{recurringTransactions:c,onUpdateRecurring:d,onDeleteRecurring:v}),e.jsx(P,{open:i,onClose:f,onSubmit:n,editingRecurring:r})]}):null}export{me as default};
